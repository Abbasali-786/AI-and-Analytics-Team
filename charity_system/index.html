<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Charity Payment Optimizer</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.4/dist/web3.min.js"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        :root {
            --primary:#2563eb; --primary-dark:#1d4ed8; --secondary:#10b981; --accent:#8b5cf6;
            --dark:#1f2937; --light:#f8fafc; --text:#374151; --text-light:#6b7280;
            --border:#e5e7eb; --success:#059669; --error:#dc2626;
        }
        body {
            font-family:'Inter',sans-serif;
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            min-height:100vh; color:var(--text);
        }
        .container { max-width:1200px; margin:0 auto; padding:20px; }
        .header { background:rgba(255,255,255,0.95); backdrop-filter:blur(10px);
            border-radius:20px; padding:30px; margin-bottom:30px; box-shadow:0 20px 40px rgba(0,0,0,0.1);
            border:1px solid rgba(255,255,255,0.2); }
        .logo { display:flex; align-items:center; gap:15px; margin-bottom:20px; }
        .logo i { font-size:2.5rem; color:var(--primary); }
        .logo h1 { 
            font-size:2rem; font-weight:700;
            background:linear-gradient(135deg,var(--primary),var(--accent));
            -webkit-background-clip: text; background-clip: text;
            -webkit-text-fill-color: transparent; color: transparent;
            display: inline-block;
        }
        .tagline { font-size:1.2rem; color:var(--text-light); margin-bottom:30px; }
        .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom:30px; }
        .stat-card { background:white; padding:25px; border-radius:15px; text-align:center;
            box-shadow:0 5px 15px rgba(0,0,0,0.08); border-left:4px solid var(--primary); transition:transform .3s; }
        .stat-card:hover { transform:translateY(-5px); }
        .stat-number { font-size:2.5rem; font-weight:700; color:var(--primary); margin-bottom:10px; }
        .stat-label { color:var(--text-light); font-size:0.9rem; }

        .workflow-steps { display:flex; justify-content:space-between; margin-bottom:40px; position:relative; }
        .workflow-steps::before { content:''; position:absolute; top:30px; left:10%; right:10%; height:3px; background:var(--border); z-index:1; }
        .step { text-align:center; position:relative; z-index:2; flex:1; }
        .step-circle { width:60px; height:60px; background:white; border:3px solid var(--border);
            border-radius:50%; display:flex; align-items:center; justify-content:center;
            margin:0 auto 15px; font-weight:600; color:var(--text-light); transition:all .3s; }
        .step.active .step-circle { background:var(--primary); border-color:var(--primary); color:white; }
        .step-label { font-size:0.9rem; color:var(--text-light); font-weight:500; }
        .step.active .step-label { color:var(--primary); font-weight:600; }

        .chat-interface, .ngo-panel, .usdc-panel { background:white; border-radius:20px; padding:30px;
            box-shadow:0 20px 40px rgba(0,0,0,0.1); margin-bottom:30px; }
        .panel-header { display:flex; align-items:center; gap:15px; margin-bottom:25px;
            padding-bottom:20px; border-bottom:1px solid var(--border); }
        .panel-header i { font-size:1.5rem; color:var(--primary); }

        .chat-messages { height:400px; overflow-y:auto; margin-bottom:20px; padding:20px;
            background:var(--light); border-radius:15px; border:1px solid var(--border); }
        .message { margin-bottom:20px; padding:15px 20px; border-radius:15px; max-width:80%; animation:fadeIn .3s; }
        .message.user { background:var(--primary); color:white; margin-left:auto; border-bottom-right-radius:5px; }
        .message.agent { background:white; border:1px solid var(--border); margin-right:auto; border-bottom-left-radius:5px; }

        .chat-input { display:flex; gap:15px; }
        .chat-input input { flex:1; padding:15px 20px; border:1px solid var(--border); border-radius:15px; font-size:1rem; outline:none; }
        .chat-input input:focus { border-color:var(--primary); }
        .chat-input button { padding:15px 25px; background:var(--primary); color:white; border:none; border-radius:15px; font-weight:600; cursor:pointer; }
        .chat-input button:hover { background:var(--primary-dark); }

        .ngo-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:20px; }
        .ngo-card { background:var(--light); padding:20px; border-radius:15px; border:1px solid var(--border); transition:transform .2s; }
        .ngo-card:hover { transform:translateY(-3px); }
        .ngo-name { font-weight:600; margin-bottom:8px; }
        .ngo-country { color:var(--text-light); font-size:0.9rem; margin-bottom:10px; }
        .ngo-wallet { font-family:monospace; font-size:0.8rem; color:var(--primary); word-break:break-all; margin-bottom:12px; }
        .ngo-card button { padding:8px 16px; background:var(--accent); color:white; border:none; border-radius:10px; cursor:pointer; font-size:0.9rem; }
        .ngo-card button:hover { background:#7c3aed; }

        .usdc-panel { display:none; text-align:center; }
        .usdc-panel input { width:100%; padding:15px; margin:15px 0; border:1px solid var(--border); border-radius:10px; font-size:1rem; }
        .usdc-panel button { padding:15px 40px; background:var(--secondary); color:white; border:none; border-radius:10px; font-weight:600; font-size:1.1rem; }
        .usdc-panel button:hover { background:#059669; }

        .connect-wallet { padding:12px 24px; background:var(--accent); color:white; border:none; border-radius:15px; font-weight:600; cursor:pointer; }
        .connect-wallet:hover { background:#7c3aed; }

        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        @media (max-width:768px) { 
            .workflow-steps { flex-direction:column; gap:20px; } 
            .workflow-steps::before { display:none; } 
            .stats-grid { grid-template-columns:1fr 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <i class="fas fa-hand-holding-heart"></i>
                <h1>AI Charity Payment Optimizer</h1>
            </div>
            <p class="tagline">Transparent, AI-powered charitable giving with blockchain security</p>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-number">8</div><div class="stat-label">AI Agents</div></div>
                <div class="stat-card"><div class="stat-number">100%</div><div class="stat-label">Transparency</div></div>
                <div class="stat-card"><div class="stat-number">$0</div><div class="stat-label">Platform Fees</div></div>
                <div class="stat-card"><div class="stat-number">24/7</div><div class="stat-label">Monitoring</div></div>
            </div>
            <button class="connect-wallet" onclick="connectWallet()">Connect Wallet</button>
            <span id="walletStatus" style="margin-left:15px; color:var(--text-light);"></span>
        </div>

        <div class="workflow-steps">
            <div class="step active"><div class="step-circle">1</div><div class="step-label">Choose Cause</div></div>
            <div class="step"><div class="step-circle">2</div><div class="step-label">AI Prediction</div></div>
            <div class="step"><div class="step-circle">3</div><div class="step-label">NGO Verification</div></div>
            <div class="step"><div class="step-circle">4</div><div class="step-label">Fund Release</div></div>
            <div class="step"><div class="step-circle">5</div><div class="step-label">Impact Report</div></div>
        </div>

        <div class="chat-interface">
            <div class="panel-header"><i class="fas fa-comments"></i><h2>Chat with AI Charity Assistant</h2></div>
            <div class="chat-messages" id="chatMessages">
                <div class="message agent"><strong>AI Assistant:</strong> Hello! I'm here to help you make a meaningful impact. How can I assist you today?</div>
            </div>
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="Ask about donations, projects, or impact..." onkeypress="handleKeyPress(event)">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>

        <div class="ngo-panel" id="ngoPanel" style="display:none;">
            <div class="panel-header"><i class="fas fa-handshake"></i><h2>Verified NGOs</h2></div>
            <div class="ngo-grid" id="ngoGrid"></div>
        </div>

        <div class="usdc-panel" id="usdcPanel" style="display:none;">
            <div class="panel-header"><i class="fas fa-coins"></i><h2>Arc Testnet â€“ USDC Transfer</h2></div>
            <input type="text" id="privateKey" placeholder="Private key (testnet only!)" />
            <input type="text" id="receiverAddress" placeholder="Receiver address" />
            <input type="number" id="usdcAmount" placeholder="Amount of USDC (e.g. 0.5)" step="0.01" />
            <button onclick="sendUSDC()">Send USDC</button>
            <p id="usdcStatus" style="margin-top:15px; color:var(--text-light);"></p>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000';
        let web3, accounts;

        async function connectWallet() {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                try {
                    accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    document.getElementById('walletStatus').innerText = `Connected: ${accounts[0].slice(0,6)}...${accounts[0].slice(-4)}`;
                } catch (err) { alert('User rejected'); }
            } else { alert('Install MetaMask!'); }
        }

        function addMessage(sender, text) {
            const div = document.createElement('div');
            div.className = `message ${sender}`;
            div.innerHTML = `<strong>${sender === 'user' ? 'You' : 'AI'}:</strong> ${text}`;
            document.getElementById('chatMessages').appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const msg = input.value.trim();
            if (!msg) return;
            addMessage('user', msg);
            input.value = '';

            const res = await fetch(`${API_BASE}/chat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: msg })
            });

            const reader = res.body.getReader();
            let response = '';
            const agentMsg = document.createElement('div');
            agentMsg.className = 'message agent';
            agentMsg.innerHTML = '<strong>AI:</strong> ';
            document.getElementById('chatMessages').appendChild(agentMsg);

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const text = new TextDecoder().decode(value);
                response += text;
                agentMsg.innerHTML = `<strong>AI:</strong> ${response}`;
                agentMsg.scrollIntoView();
            }

            if (response.toLowerCase().includes('ngo') || msg.toLowerCase().includes('ngo')) {
                setTimeout(() => {
                    document.getElementById('ngoPanel').style.display = 'block';
                    document.getElementById('usdcPanel').style.display = 'block';
                    searchNGOs(extractCountry(msg) || 'Pakistan');
                }, 1000);
            }
        }

        function handleKeyPress(e) { if (e.key === 'Enter') sendMessage(); }

        function extractCountry(msg) {
            const match = msg.match(/in\s+([a-zA-Z]+)/i);
            return match ? match[1].charAt(0).toUpperCase() + match[1].slice(1).toLowerCase() : null;
        }

        async function searchNGOs(q) {
            const res = await fetch(`${API_BASE}/research?q=${q}`);
            const ngos = await res.json();
            const grid = document.getElementById('ngoGrid');
            grid.innerHTML = '';
            ngos.forEach(ngo => {
                const card = document.createElement('div');
                card.className = 'ngo-card';
                card.innerHTML = `
                    <div class="ngo-name">${ngo.name}</div>
                    <div class="ngo-country">${ngo.country}</div>
                    <div class="ngo-wallet">${ngo.wallet}</div>
                    <button onclick="selectNGO('${ngo.wallet}')">Select & Donate</button>
                `;
                grid.appendChild(card);
            });
        }

        function selectNGO(wallet) {
            document.getElementById('receiverAddress').value = wallet;
        }

        // === FULLY WORKING USDC TRANSFER (CORRECT ADDRESS) ===
        async function sendUSDC() {
            const pk = document.getElementById('privateKey').value.trim();
            const to = document.getElementById('receiverAddress').value.trim();
            const amount = document.getElementById('usdcAmount').value;
            const status = document.getElementById('usdcStatus');

            if (!pk || !to || !amount) return status.innerText = 'Fill all fields';

            try {
                const provider = new Web3.providers.HttpProvider('https://rpc.testnet.arc.network');
                const web3Local = new Web3(provider);
                const account = web3Local.eth.accounts.privateKeyToAccount(pk);
                web3Local.eth.accounts.wallet.add(account);

                const usdcABI = [{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];
                const usdcAddress = "0x41e94eb019c0762f9bfcf9fb429c8daa7d4e4d1e"; // CORRECT ADDRESS
                const usdcContract = new web3Local.eth.Contract(usdcABI, usdcAddress);

                const amountWei = web3Local.utils.toBN(amount * 1e6); // 6 decimals
                const gas = await usdcContract.methods.transfer(to, amountWei).estimateGas({ from: account.address });

                const tx = await usdcContract.methods.transfer(to, amountWei).send({
                    from: account.address,
                    gas: gas + 10000
                });

                const explorer = `https://testnet.arcscan.app/tx/${tx.transactionHash}`;
                status.innerHTML = `Success! Tx: <a href="${explorer}" target="_blank">${tx.transactionHash.slice(0,10)}...</a>`;
                addMessage('agent', `Donation sent! Track: <a href="${explorer}" target="_blank">${tx.transactionHash}</a>`);
            } catch (err) {
                status.innerText = `Error: ${err.message}`;
            }
        }

        setTimeout(() => addMessage('agent', "Ask me: 'Find NGOs in Pakistan' to start donating!"), 1500);
    </script>
</body>
</html>
