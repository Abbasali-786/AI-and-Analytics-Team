# server.py — Charity System (NO openai package, uses requests)
from flask import Flask, request, jsonify, Response
from web3 import Web3
import json, os, uuid, requests
from dotenv import load_dotenv
from requests.adapters import HTTPAdapter
from urllib3.util import Retry

load_dotenv()
app = Flask(__name__)

# === CORS ===
@app.after_request
def after_request(resp):
    resp.headers['Access-Control-Allow-Origin'] = '*'
    resp.headers['Access-Control-Allow-Headers'] = 'Content-Type'
    resp.headers['Access-Control-Allow-Methods'] = 'GET,POST,OPTIONS'
    return resp

# === AI‑ML API – DIRECT REQUESTS (NO openai) ===
AIML_KEY = os.getenv("AIML_API_KEY")
if not AIML_KEY:
    print("ERROR: AIML_API_KEY missing in .env")
    exit(1)

def call_aiml(prompt: str):
    url = "https://api.aimlapi.com/v1/chat/completions"
    headers = {
        "Authorization": f"Bearer {AIML_KEY}",
        "Content-Type": "application/json"
    }
    payload = {
        "model": "gpt-4o",
        "messages": [{"role": "user", "content": prompt}],
        "temperature": 0.7
    }
    try:
        r = requests.post(url, json=payload, headers=headers, timeout=30)
        r.raise_for_status()
        return r.json()["choices"][0]["message"]["content"]
    except Exception as e:
        return f"[AI Error: {str(e)}]"

# === ElevenLabs agents ===
ELEVENLABS_KEY = os.getenv("ELEVENLABS_API_KEY")
if not ELEVENLABS_KEY:
    print("WARNING: ELEVENLABS_API_KEY missing – chat will use AI‑ML fallback")
with open("../agents/agent_ids.json") as f:
    AGENT_IDS = json.load(f)

session = requests.Session()
retry = Retry(total=3, backoff_factor=1, status_forcelist=[429, 500, 502, 503, 504])
session.mount("https://", HTTPAdapter(max_retries=retry))

def call_elevenlabs(agent_id: str, message: str, history: list):
    url = "https://api.elevenlabs.io/v1/convai/conversations"
    headers = {"xi-api-key": ELEVENLABS_KEY, "Content-Type": "application/json"}
    payload = {"agent_id": agent_id, "message": message, "history": history or []}
    try:
        r = session.post(url, json=payload, headers=headers, stream=True, timeout=30)
        r.raise_for_status()
        for line in r.iter_lines(decode_unicode=True):
            if line.strip():
                try:
                    data = json.loads(line)
                    if data.get("content"):
                        yield data["content"]
                except json.JSONDecodeError:
                    continue
    except requests.exceptions.HTTPError as e:
        yield f"[Agent Error: {e.response.status_code} {e.response.text}]"
    except Exception as e:
        yield f"[Agent Error: {str(e)}]"

# === Web3 – Auto‑fallback ===
RPC_LIST = [
    ("Arc Testnet", "https://rpc.testnet.arc.network", 5042002),
    ("Polygon Mumbai", "https://rpc-mumbai.maticvigil.com", 80001),
    ("Polygon Amoy", "https://rpc-amoy.polygon.technology", 80002)
]

w3 = None
usdc = None
chain_info = None

for name, rpc, chain_id in RPC_LIST:
    try:
        w3_tmp = Web3(Web3.HTTPProvider(rpc, request_kwargs={'timeout': 8}))
        if w3_tmp.is_connected():
            w3, chain_info = w3_tmp, {"name": name, "rpc": rpc, "chain_id": chain_id}
            break
    except:
        pass

if w3:
    print(f"Web3 connected: {chain_info['name']} ({chain_info['rpc']})")
    USDC = os.getenv("USDC_CONTRACT", "0x41E94Eb019C0762f9Bfcf9Fb2E58725BfB0e7582")
    with open("../abi.json") as f:
        ABI = json.load(f)
    usdc = w3.eth.contract(address=USDC, abi=ABI)
else:
    print("Web3: All RPCs down – donation disabled")
    usdc = None

# === NGO cache ===
NGO_DB = {}

# === Routes ===
@app.route('/')
def home():
    return "AI Charity Backend Running"

@app.route('/research')
def research():
    q = request.args.get('q', 'climate Europe')
    prompt = f"Find 5 real, verified NGOs in Europe focused on '{q}'. Return ONLY valid JSON array with: name, country, website, ein (if available)."
    content = call_aiml(prompt)
    
    try:
        if content.startswith("```json"): content = content[7:-3]
        if content.startswith("```"): content = content[3:-3]
        data = json.loads(content)

        for ngo in data:
            ngo_id = str(uuid.uuid4())[:8]
            wallet = f"0x{ngo_id}abc{ngo_id[::-1]}def"
            ngo['wallet'] = wallet
            ngo['rating'] = 90
            NGO_DB[ngo['name']] = ngo

        return jsonify(data)
    except Exception as e:
        return jsonify({"error": str(e)}), 500

@app.route('/donate', methods=['POST', 'OPTIONS'])
def donate():
    if request.method == "OPTIONS": return "", 200
    if not w3 or not usdc:
        return jsonify({"success": False, "error": "Blockchain not available"}), 503

    data = request.json
    pk, to, amount = data.get('pk'), data.get('to'), data.get('amount')
    if not all([pk, to, amount]):
        return jsonify({"success": False, "error": "Missing fields"}), 400

    try:
        account = w3.eth.account.from_key(pk)
        nonce = w3.eth.get_transaction_count(account.address)
        tx = usdc.functions.transfer(to, int(float(amount) * 1e6)).build_transaction({
            'chainId': chain_info["chain_id"],
            'gas': 100_000,
            'gasPrice': w3.to_wei('20', 'gwei'),
            'nonce': nonce,
        })
        signed = account.sign_transaction(tx)
        tx_hash = w3.eth.send_raw_transaction(signed.rawTransaction).hex()
        return jsonify({"success": True, "hash": tx_hash})
    except Exception as e:
        return jsonify({"success": False, "error": str(e)}), 500

@app.route('/chat', methods=['POST', 'OPTIONS'])
def chat():
    if request.method == "OPTIONS": return "", 200
    try:
        payload = request.json
        user_msg = payload.get("message", "").strip()
        history = payload.get("history", [])
        agent_id = AGENT_IDS["Orchestrator Agent"]

        def stream():
            for token in call_elevenlabs(agent_id, user_msg, history):
                yield token
        return Response(stream(), mimetype="text/plain")
    except Exception as e:
        return Response(f"Server Error: {str(e)}", mimetype="text/plain"), 500

@app.route('/agents')
def list_agents():
    return jsonify([{"name": n, "id": i, "purpose": "Charity AI agent"} for n, i in AGENT_IDS.items()])

if __name__ == '__main__':
    print("AI Charity Server (Direct API + 8 ElevenLabs agents) → http://localhost:5000")
    for name in AGENT_IDS:
        print(f"  • {name}")
    app.run(port=5000, debug=True, threaded=True)
